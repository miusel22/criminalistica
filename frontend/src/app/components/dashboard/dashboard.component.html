<div class="dashboard-shell" *ngIf="userProfile">

  <header class="dashboard-header">
    <div class="logo">
      <span class="material-icons">shield</span>
      <h1>Panel de Control</h1>
    </div>
    <div class="user-info">
      <span class="user-info__name">Bienvenido, <strong>{{ userProfile.full_name || userProfile.username }}</strong></span>
      <button (click)="logout()" class="btn btn--logout" title="Cerrar Sesión">
        <span class="material-icons">logout</span>
      </button>
    </div>
  </header>

  <main class="dashboard-main">
    
    <aside class="dashboard-sidebar">
      <div class="sidebar-header">
        <h2>Sectores</h2>
        <button (click)="crearNuevaCarpeta(false)" class="btn btn--add" title="Añadir nuevo sector">
          <span class="material-icons">add</span>
        </button>
      </div>
      <div *ngIf="isLoadingCarpetas" class="sidebar-loader">Cargando...</div>
      <ul *ngIf="!isLoadingCarpetas" class="sidebar-list">
        <li *ngFor="let carpeta of carpetasPadre" 
            (click)="seleccionarSector(carpeta)"
            class="sidebar-list__item"
            [class.sidebar-list__item--active]="carpeta.id === sectorSeleccionado?.id">
          <span class="material-icons">folder_special</span>
          <span>{{ carpeta.nombre }}</span>
        </li>
        <li *ngIf="carpetasPadre.length === 0" class="sidebar-list__empty">No hay sectores creados.</li>
      </ul>
    </aside>

    <section class="dashboard-content">

      <div *ngIf="!sectorSeleccionado && !isLoadingDetalles" class="content-placeholder">
        <span class="material-icons placeholder-icon">explore</span>
        <h2>Selecciona un sector para empezar</h2>
        <p>Toda la información de tus sectores aparecerá aquí.</p>
      </div>

      <div *ngIf="isLoadingDetalles" class="content-loader">
        <div class="spinner"></div>
        <p>Cargando datos...</p>
      </div>
      
      <div *ngIf="sectorSeleccionado && !subSectorSeleccionado && !isLoadingDetalles" class="content-view">
        <header class="content-header">
          <h3>Sub-Sectores en "{{ sectorSeleccionado.nombre }}"</h3>
          <div class="header-actions">
            <button (click)="crearNuevaCarpeta(true)" class="btn btn--primary-outline">
              <span class="material-icons">add_circle_outline</span> Añadir Sub-sector
            </button>
            <button (click)="borrarCarpeta(sectorSeleccionado)" class="btn btn--danger" title="Borrar Sector Completo">
              <span class="material-icons">delete_sweep</span> Borrar Sector
            </button>
          </div>
        </header>
        <div *ngIf="sectorSeleccionado.sub_carpetas && sectorSeleccionado.sub_carpetas.length > 0; else noSubSectores" class="subfolder-grid">
            <div *ngFor="let sub of sectorSeleccionado.sub_carpetas" class="subfolder-card" (click)="seleccionarSubSector(sub)">
                <span class="material-icons">location_city</span>
                <span>{{ sub.nombre }}</span>
            </div>
        </div>
        <ng-template #noSubSectores>
          <div class="content-placeholder secondary">
            <span class="material-icons placeholder-icon">add_location_alt</span>
            <h2>Este sector no tiene sub-sectores</h2>
            <p>Puedes añadir uno usando el botón de arriba.</p>
          </div>
        </ng-template>
      </div>

      <div *ngIf="subSectorSeleccionado && !isLoadingDetalles" class="content-view">
        <header class="content-header">
            <div class="breadcrumb">
              <a (click)="volverASubSectores()" class="breadcrumb__link" title="Volver a {{ sectorSeleccionado?.nombre }}">
                <span class="material-icons">folder_special</span>
                {{ sectorSeleccionado?.nombre }}
              </a>
              <span class="breadcrumb__separator">/</span>
              <span class="breadcrumb__active">
                <span class="material-icons">location_city</span>
                {{ subSectorSeleccionado.nombre }}
              </span>
            </div>
            <div class="header-actions">
              <button (click)="prepararFormulario(null)" class="btn btn--primary">
                <span class="material-icons">person_add</span> Añadir Indiciado
              </button>
              <button (click)="borrarCarpeta(subSectorSeleccionado)" class="btn btn--danger-outline" title="Borrar este sub-sector">
                <span class="material-icons">delete</span>
              </button>
            </div>
        </header>
        <div *ngIf="!subSectorSeleccionado.indiciados || subSectorSeleccionado.indiciados.length === 0" class="content-placeholder secondary">
          <span class="material-icons placeholder-icon">person_search</span>
          <h2>No hay indiciados en este sub-sector</h2>
          <p>Añade el primero para empezar a construir tu base de datos.</p>
        </div>
        <div class="indiciados-grid">
          <div *ngFor="let indiciado of subSectorSeleccionado.indiciados || []" class="indiciado-card">
              <div class="indiciado-card__photo-wrapper">
                <img [src]="indiciado.foto_url ? 'http://127.0.0.1:5000' + indiciado.foto_url : 'assets/placeholder-person.png'" 
                     alt="Foto de {{indiciado.nombres}}" class="indiciado-card__photo">
              </div>
              <div class="indiciado-card__info">
                  <h4>{{ indiciado.nombres }} {{ indiciado.apellidos }}</h4>
                  <p class="info-item"><span class="material-icons">fingerprint</span>{{ indiciado.cc }}</p>
                  <p *ngIf="indiciado.alias" class="info-item"><span class="material-icons">theater_comedy</span>{{ indiciado.alias }}</p>
              </div>
              <div class="indiciado-card__actions">
                  <button (click)="verIndiciado(indiciado)" class="btn btn--icon" title="Ver Detalles"><span class="material-icons">visibility</span></button>
                  <button (click)="prepararFormulario(indiciado)" class="btn btn--icon" title="Editar"><span class="material-icons">edit</span></button>
                  <button (click)="borrarIndiciado(indiciado.id)" class="btn btn--icon btn--danger-text" title="Eliminar"><span class="material-icons">delete_forever</span></button>
              </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div *ngIf="isFormVisible" class="overlay" (click)="cerrarFormulario()">
    <form [formGroup]="indiciadoForm" (ngSubmit)="onSubmitIndiciado()" class="modal-form" (click)="$event.stopPropagation()">
      <header class="form-header">
        <h3>{{ isEditingIndiciado ? 'Editar' : 'Nuevo' }} Indiciado</h3>
        <button type="button" class="btn btn--close" (click)="cerrarFormulario()" title="Cerrar"><span class="material-icons">close</span></button>
      </header>
      <div class="form-content">
        <div class="form-grid">
            <div class="form-field"><label for="nombres">Nombres*</label><input id="nombres" formControlName="nombres"></div>
            <div class="form-field"><label for="apellidos">Apellidos*</label><input id="apellidos" formControlName="apellidos"></div>
            <div class="form-field"><label for="cc">Cédula*</label><input id="cc" formControlName="cc"></div>
            <div class="form-field"><label for="alias">Alias</label><input id="alias" formControlName="alias"></div>
            <div class="form-field"><label for="fecha_nacimiento">Fecha Nacimiento</label><input id="fecha_nacimiento" type="date" formControlName="fecha_nacimiento"></div>
            <div class="form-field"><label for="edad">Edad</label><input id="edad" type="number" formControlName="edad"></div>
            <div class="form-field span-2"><label for="hijo_de">Hijo de</label><input id="hijo_de" formControlName="hijo_de"></div>
            <div class="form-field"><label for="estado_civil">Estado Civil</label><input id="estado_civil" formControlName="estado_civil"></div>
            <div class="form-field"><label for="telefono">Teléfono</label><input id="telefono" formControlName="telefono"></div>
            <div class="form-field span-2"><label for="residencia">Residencia</label><input id="residencia" formControlName="residencia"></div>
            <div class="form-field span-2"><label for="estudios_realizados">Estudios</label><input id="estudios_realizados" formControlName="estudios_realizados"></div>
            <div class="form-field"><label for="profesion">Profesión</label><input id="profesion" formControlName="profesion"></div>
            <div class="form-field"><label for="oficio">Oficio</label><input id="oficio" formControlName="oficio"></div>
            <div class="form-field span-2"><label for="senales_fisicas">Señales Físicas</label><textarea id="senales_fisicas" formControlName="senales_fisicas" rows="3"></textarea></div>
            <div class="form-field span-2"><label for="banda_delincuencial">Banda Delincuencial</label><input id="banda_delincuencial" formControlName="banda_delincuencial"></div>
            <div class="form-field span-2"><label for="delitos_atribuidos">Delitos Atribuidos</label><textarea id="delitos_atribuidos" formControlName="delitos_atribuidos" rows="3"></textarea></div>
            <div class="form-field span-2"><label for="situacion_juridica">Situación Jurídica</label><input id="situacion_juridica" formControlName="situacion_juridica"></div>
            <div class="form-field span-2"><label for="observaciones">Observaciones</label><textarea id="observaciones" formControlName="observaciones" rows="4"></textarea></div>
            <div class="form-field span-2"><label for="foto">Foto</label><input id="foto" type="file" (change)="onFileChange($event)"></div>
        </div>
      </div>
      <footer class="form-footer">
        <button type="button" (click)="cerrarFormulario()" class="btn btn--secondary">Cancelar</button>
        <button type="submit" [disabled]="indiciadoForm.invalid || isSubmitting" class="btn btn--primary">
          <span *ngIf="!isSubmitting">{{ isEditingIndiciado ? 'Guardar Cambios' : 'Crear Indiciado' }}</span>
          <span *ngIf="isSubmitting">Procesando...</span>
        </button>
      </footer>
    </form>
  </div>

  <div *ngIf="indiciadoParaVer" class="overlay" (click)="cerrarVistaIndiciado()">
    <div class="modal-detail" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <h3>Individualización</h3>
        <button type="button" class="btn btn--close" (click)="cerrarVistaIndiciado()" title="Cerrar"><span class="material-icons">close</span></button>
      </header>
      <div class="modal-content">
        <div class="detail-grid">
            <div class="detail-col">
              <div class="detail-photo-wrapper">
                <img [src]="indiciadoParaVer.foto_url ? 'http://127.0.0.1:5000' + indiciadoParaVer.foto_url : 'assets/placeholder-person.png'" 
                     alt="Foto de {{indiciadoParaVer.nombres}}" class="detail-photo">
              </div>
              <div class="detail-group">
                <div class="detail-item"><span class="label">Nombres</span><span class="value">{{ indiciadoParaVer.nombres }}</span></div>
                <div class="detail-item"><span class="label">Apellidos</span><span class="value">{{ indiciadoParaVer.apellidos }}</span></div>
                <div class="detail-item"><span class="label">Documento de Identidad</span><span class="value">{{ indiciadoParaVer.cc }}</span></div>
                <div class="detail-item" *ngIf="indiciadoParaVer.alias"><span class="label">Alias</span><span class="value">{{ indiciadoParaVer.alias }}</span></div>
                <div class="detail-item"><span class="label">Fecha de Nacimiento</span><span class="value">{{ indiciadoParaVer.fecha_nacimiento | date:'longDate' }}</span></div>
                <div class="detail-item"><span class="label">Edad</span><span class="value">{{ indiciadoParaVer.edad }} años</span></div>
              </div>
            </div>
            <div class="detail-col">
              <div class="detail-group">
                <h5 class="group-title">Información Personal</h5>
                <div class="detail-item"><span class="label">Hijo de</span><span class="value">{{ indiciadoParaVer.hijo_de || 'N/A' }}</span></div>
                <div class="detail-item"><span class="label">Estado Civil</span><span class="value">{{ indiciadoParaVer.estado_civil || 'N/A' }}</span></div>
                <div class="detail-item"><span class="label">Residencia</span><span class="value">{{ indiciadoParaVer.residencia || 'N/A' }}</span></div>
                <div class="detail-item"><span class="label">Teléfono</span><span class="value">{{ indiciadoParaVer.telefono || 'N/A' }}</span></div>
              </div>
              <div class="detail-group">
                <h5 class="group-title">Formación y Ocupación</h5>
                <div class="detail-item"><span class="label">Estudios Realizados</span><span class="value">{{ indiciadoParaVer.estudios_realizados || 'N/A' }}</span></div>
                <div class="detail-item"><span class="label">Profesión</span><span class="value">{{ indiciadoParaVer.profesion || 'N/A' }}</span></div>
                <div class="detail-item"><span class="label">Oficio</span><span class="value">{{ indiciadoParaVer.oficio || 'N/A' }}</span></div>
              </div>
              <div class="detail-group">
                <h5 class="group-title">Información Relevante</h5>
                <div class="detail-item"><span class="label">Señales Físicas</span><span class="value long-text">{{ indiciadoParaVer.senales_fisicas || 'N/A' }}</span></div>
                <div class="detail-item"><span class="label">Banda Delincuencial</span><span class="value">{{ indiciadoParaVer.banda_delincuencial || 'N/A' }}</span></div>
                <div class="detail-item"><span class="label">Delitos Atribuidos</span><span class="value long-text">{{ indiciadoParaVer.delitos_atribuidos || 'N/A' }}</span></div>
                <div class="detail-item"><span class="label">Situación Jurídica</span><span class="value">{{ indiciadoParaVer.situacion_juridica || 'N/A' }}</span></div>
              </div>
            </div>
        </div>
        <div class="detail-group full-width">
            <h5 class="group-title">Observaciones</h5>
            <p class="observations-text">{{ indiciadoParaVer.observaciones || 'No hay observaciones.' }}</p>
        </div>
      </div>
      <footer class="modal-footer">
        <button type="button" (click)="cerrarVistaIndiciado()" class="btn btn--secondary">Cerrar</button>
      </footer>
    </div>
  </div>

</div>