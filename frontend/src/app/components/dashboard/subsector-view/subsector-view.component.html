@if (!isLoading && subSector) {
  <div class="breadcrumb">
    @if (sectorPadre) {
      <a [routerLink]="['/dashboard', 'sector', sectorPadre.id]" class="breadcrumb__link">
        {{ sectorPadre.nombre }}
      </a>
      <span class="breadcrumb__separator">/</span>
    }
    <span class="breadcrumb__active">{{ subSector.nombre }}</span>
  </div>

  <div class="view-header">
    <h1>Indiciados en "{{ subSector.nombre }}"</h1>
    <div class="header-actions">
      <button (click)="editarSubSectorActual()" class="btn btn--secondary" title="Editar este sub-sector">
        <span class="material-icons">edit</span> Editar Sub-sector
      </button>
      <button (click)="borrarSubSectorActual()" class="btn btn--danger-outline" title="Eliminar este sub-sector">
        <span class="material-icons">delete_forever</span> Eliminar
      </button>

      <button (click)="prepararFormulario(null)" class="btn btn--primary">
        <span class="material-icons">person_add</span> Añadir Indiciado
      </button>
    </div>
  </div>

  @if (!subSector.indiciados || subSector.indiciados.length === 0) {
    <div class="content-placeholder secondary">
      <span class="material-icons placeholder-icon">person_search</span>
      <h2>No hay indiciados en este sub-sector</h2>
      <p>Añade el primero para empezar.</p>
    </div>
  } @else {
    <div class="indiciados-grid">
      @for (indiciado of subSector.indiciados; track indiciado.id) {
        <div class="indiciado-card">
          <div class="indiciado-card__photo-wrapper">
            <img [src]="indiciado.foto_url ? 'http://127.0.0.1:5000' + indiciado.foto_url : 'assets/placeholder-person.png'" 
                 alt="Foto de {{indiciado.nombres}}" class="indiciado-card__photo">
          </div>
          <div class="indiciado-card__info">
              <h4>{{ indiciado.nombres }} {{ indiciado.apellidos }}</h4>
              <p class="info-item"><span class="material-icons">fingerprint</span>{{ indiciado.cc }}</p>
              @if(indiciado.alias) {
                <p class="info-item"><span class="material-icons">theater_comedy</span>{{ indiciado.alias }}</p>
              }
          </div>
          <div class="indiciado-card__actions">
              <button (click)="verIndiciado(indiciado)" class="btn btn--icon" title="Ver Detalles"><span class="material-icons">visibility</span></button>
              <button (click)="prepararFormulario(indiciado)" class="btn btn--icon" title="Editar"><span class="material-icons">edit</span></button>
              <button (click)="borrarIndiciado(indiciado.id)" class="btn btn--icon btn--danger-text" title="Eliminar"><span class="material-icons">delete_forever</span></button>
          </div>
        </div>
      }
    </div>
  }

} @else {
  <div class="content-loader">
    <div class="spinner"></div>
    <p>Cargando datos del sub-sector...</p>
  </div>
}

@if (isFormVisible || indiciadoParaVer) {
  <div class="overlay" (click)="isFormVisible ? cerrarFormulario() : cerrarVistaIndiciado()">
    
    @if (isFormVisible) {
      <form [formGroup]="indiciadoForm" (ngSubmit)="onSubmitIndiciado()" class="modal-form" (click)="$event.stopPropagation()">
        <header class="form-header">
          <h3>{{ isEditingIndiciado ? 'Editar Indiciado' : 'Nuevo Indiciado' }}</h3>
          <button type="button" class="btn btn--close" (click)="cerrarFormulario()" title="Cerrar"><span class="material-icons">close</span></button>
        </header>
        <div class="form-content">
          <div class="form-grid">
            
            <div class="form-field"><label for="nombres">Nombres*</label><input id="nombres" formControlName="nombres"></div>
            <div class="form-field"><label for="apellidos">Apellidos*</label><input id="apellidos" formControlName="apellidos"></div>
            <div class="form-field"><label for="cc">Cédula de Ciudadanía*</label><input id="cc" formControlName="cc"></div>
            <div class="form-field"><label for="alias">Alias</label><input id="alias" formControlName="alias"></div>
            <div class="form-field"><label for="fecha_nacimiento">Fecha de Nacimiento</label><input id="fecha_nacimiento" type="date" formControlName="fecha_nacimiento"></div>
            <div class="form-field"><label for="edad">Edad</label><input id="edad" type="number" formControlName="edad"></div>
            
            <div class="form-field span-2"><label for="hijo_de">Hijo de</label><input id="hijo_de" formControlName="hijo_de"></div>
            <div class="form-field"><label for="estado_civil">Estado Civil</label><input id="estado_civil" formControlName="estado_civil"></div>
            <div class="form-field"><label for="telefono">Teléfono</label><input id="telefono" formControlName="telefono"></div>
            <div class="form-field span-2"><label for="residencia">Lugar de Residencia</label><input id="residencia" formControlName="residencia"></div>

            <div class="form-field span-2"><label for="estudios_realizados">Estudios Realizados</label><input id="estudios_realizados" formControlName="estudios_realizados"></div>
            <div class="form-field"><label for="profesion">Profesión</label><input id="profesion" formControlName="profesion"></div>
            <div class="form-field"><label for="oficio">Oficio</label><input id="oficio" formControlName="oficio"></div>
            
            <div class="form-field span-2"><label for="senales_fisicas">Señales Físicas Particulares</label><textarea id="senales_fisicas" formControlName="senales_fisicas" rows="3"></textarea></div>
            <div class="form-field span-2"><label for="banda_delincuencial">Banda Delincuencial</label><input id="banda_delincuencial" formControlName="banda_delincuencial"></div>
            <div class="form-field span-2"><label for="delitos_atribuidos">Delitos Atribuidos</label><textarea id="delitos_atribuidos" formControlName="delitos_atribuidos" rows="3"></textarea></div>
            <div class="form-field span-2"><label for="situacion_juridica">Situación Jurídica</label><input id="situacion_juridica" formControlName="situacion_juridica"></div>
            
            <div class="form-field span-2"><label for="observaciones">Observaciones Generales</label><textarea id="observaciones" formControlName="observaciones" rows="4"></textarea></div>
            <div class="form-field span-2"><label for="foto">Fotografía</label><input id="foto" type="file" (change)="onFileChange($event)"></div>
            <div class="form-field span-2">
              <label for="google_earth_link">Link de Google Earth</label>
              <input id="google_earth_link" formControlName="google_earth_link" placeholder="Pegue aquí el link completo de Google Earth...">
            </div>
            <div class="form-field span-2">
              <label for="documentos">Adjuntar Documentos (PDF, Word, etc.)</label>
              <input id="documentos" type="file" multiple (change)="onDocumentosSeleccionados($event)">
              @if (documentosParaSubir.length > 0) {
                <div class="file-list">
                    <strong>Archivos para subir:</strong>
                    <ul>
                        @for(file of documentosParaSubir; track file.name) {
                            <li>{{ file.name }} ({{ (file.size / 1024).toFixed(2) }} KB)</li>
                        }
                    </ul>
                </div>
              }
            </div>
          </div>
        </div>
        <footer class="form-footer">
          <button type="button" (click)="cerrarFormulario()" class="btn btn--secondary">Cancelar</button>
          <button type="submit" [disabled]="indiciadoForm.invalid || isSubmitting" class="btn btn--primary">
            <span *ngIf="!isSubmitting">{{ isEditingIndiciado ? 'Guardar Cambios' : 'Crear Indiciado' }}</span>
            <span *ngIf="isSubmitting">Procesando...</span>
          </button>
        </footer>
      </form>
    }

    @if (indiciadoParaVer) {
      <div class="modal-detail" (click)="$event.stopPropagation()">
        <header class="modal-header">
          <h3>Ficha de Individualización</h3>
          <button type="button" class="btn btn--close" (click)="cerrarVistaIndiciado()" title="Cerrar"><span class="material-icons">close</span></button>
        </header>
        <div class="modal-content">
          <div class="detail-grid">
              <div class="detail-col">
                <div class="detail-photo-wrapper">
                  <img [src]="indiciadoParaVer.foto_url ? 'http://127.0.0.1:5000' + indiciadoParaVer.foto_url : 'assets/placeholder-person.png'" 
                       alt="Foto de {{indiciadoParaVer.nombres}}" class="detail-photo">
                </div>
                <div class="detail-group">
                  <div class="detail-item"><span class="label">Nombres</span><span class="value">{{ indiciadoParaVer.nombres }}</span></div>
                  <div class="detail-item"><span class="label">Apellidos</span><span class="value">{{ indiciadoParaVer.apellidos }}</span></div>
                  <div class="detail-item"><span class="label">Documento (CC)</span><span class="value">{{ indiciadoParaVer.cc }}</span></div>
                  @if (indiciadoParaVer.alias) {
                    <div class="detail-item"><span class="label">Alias</span><span class="value">{{ indiciadoParaVer.alias }}</span></div>
                  }
                  @if (indiciadoParaVer.fecha_nacimiento) {
                    <div class="detail-item"><span class="label">Fecha de Nacimiento</span><span class="value">{{ indiciadoParaVer.fecha_nacimiento | date:'longDate' }}</span></div>
                  }
                  @if (indiciadoParaVer.edad) {
                    <div class="detail-item"><span class="label">Edad</span><span class="value">{{ indiciadoParaVer.edad }} años</span></div>
                  }
                </div>
                @if (indiciadoParaVer.google_earth_link) {
                  <div class="detail-group">
                    <div class="detail-item">
                      <span class="label">Ubicación de Referencia</span>
                      <button type="button" (click)="abrirLinkGoogleEarth(indiciadoParaVer.google_earth_link)" class="btn btn--primary-outline">
                        <span class="material-icons">public</span> Abrir en Google Earth
                      </button>
                    </div>
                  </div>
                }
              </div>
              <div class="detail-col">
                <div class="detail-group">
                  <h5 class="group-title">Información Personal</h5>
                  <div class="detail-item"><span class="label">Hijo de</span><span class="value">{{ indiciadoParaVer.hijo_de || 'N/A' }}</span></div>
                  <div class="detail-item"><span class="label">Estado Civil</span><span class="value">{{ indiciadoParaVer.estado_civil || 'N/A' }}</span></div>
                  <div class="detail-item"><span class="label">Residencia</span><span class="value">{{ indiciadoParaVer.residencia || 'N/A' }}</span></div>
                  <div class="detail-item"><span class="label">Teléfono</span><span class="value">{{ indiciadoParaVer.telefono || 'N/A' }}</span></div>
                </div>
                <div class="detail-group">
                  <h5 class="group-title">Formación y Ocupación</h5>
                  <div class="detail-item"><span class="label">Estudios Realizados</span><span class="value">{{ indiciadoParaVer.estudios_realizados || 'N/A' }}</span></div>
                  <div class="detail-item"><span class="label">Profesión</span><span class="value">{{ indiciadoParaVer.profesion || 'N/A' }}</span></div>
                  <div class="detail-item"><span class="label">Oficio</span><span class="value">{{ indiciadoParaVer.oficio || 'N/A' }}</span></div>
                </div>
              </div>
          </div>
          <div class="detail-group full-width">
              <h5 class="group-title">Información Relevante</h5>
              <div class="detail-item"><span class="label">Señales Físicas Particulares</span><span class="value long-text">{{ indiciadoParaVer.senales_fisicas || 'No registradas.' }}</span></div>
              <div class="detail-item"><span class="label">Banda Delincuencial</span><span class="value">{{ indiciadoParaVer.banda_delincuencial || 'N/A' }}</span></div>
              <div class="detail-item"><span class="label">Delitos Atribuidos</span><span class="value long-text">{{ indiciadoParaVer.delitos_atribuidos || 'No registrados.' }}</span></div>
              <div class="detail-item"><span class="label">Situación Jurídica</span><span class="value">{{ indiciadoParaVer.situacion_juridica || 'N/A' }}</span></div>
          </div>
          <div class="detail-group full-width">
              <h5 class="group-title">Observaciones</h5>
              <p class="observations-text">{{ indiciadoParaVer.observaciones || 'No hay observaciones.' }}</p>
          </div>
          <div class="detail-group full-width">
            <h5 class="group-title">Documentos Adjuntos</h5>
            @if (indiciadoParaVer.documentos && indiciadoParaVer.documentos.length > 0) {
                <ul class="document-list">
                    @for(doc of indiciadoParaVer.documentos; track doc.id) {
                        <li class="document-item">
                            <div class="doc-info">
                                <span class="material-icons">description</span>
                                <span>{{ doc.filename }}</span>
                            </div>
                            <div class="doc-actions">
                                @if (['pdf', 'doc', 'docx'].includes(doc.filename.split('.').pop()?.toLowerCase() || '')) {
                                    <button (click)="visualizarDocumento(doc)" class="btn btn--icon" title="Visualizar">
                                        <span class="material-icons">visibility</span>
                                    </button>
                                }
                                <a [href]="'http://127.0.0.1:5000' + doc.url" target="_blank" class="btn btn--icon" title="Descargar">
                                    <span class="material-icons">download</span>
                                </a>
                                <button (click)="eliminarDocumento(doc.id, $event)" class="btn btn--icon btn--danger-text" title="Eliminar">
                                    <span class="material-icons">delete</span>
                                </button>
                            </div>
                        </li>
                    }
                </ul>
            } @else {
                <p class="no-docs-message">No hay documentos adjuntos para este perfil.</p>
            }
          </div>
        </div>
        <footer class="modal-footer">
          <button type="button" (click)="cerrarVistaIndiciado()" class="btn btn--secondary">Cerrar</button>
        </footer>
      </div>
    }
  </div>
}

@if (safeDocUrl) {
    <div class="overlay doc-viewer-overlay" (click)="cerrarVisualizador()">
        <div class="doc-viewer-modal" (click)="$event.stopPropagation()">
            <header class="doc-viewer-header">
                <h3>Visualizador de Documentos</h3>
                <button (click)="cerrarVisualizador()" class="btn btn--close" title="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div class="doc-viewer-content">
                <iframe [src]="safeDocUrl" frameborder="0"></iframe>
            </div>
        </div>
    </div>
}