const mongoose = require('mongoose');
const { sequelize, User, Sector, Vehiculo, Indiciado, syncDatabase } = require('./models/sequelize');
const { v4: uuidv4 } = require('uuid');
require('dotenv').config();

// Import MongoDB models
const UserMongo = require('./models/User');
const SectorMongo = require('./models/Sector');
const VehiculoMongo = require('./models/Vehiculo');
const IndiciadoMongo = require('./models/Indiciado');

// Conectar a MongoDB
const connectMongoDB = async () => {
  try {
    await mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/criminalistica_db', {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    });
    console.log('üì¶ MongoDB connected for migration');
  } catch (error) {
    console.error('‚ùå MongoDB connection error:', error);
    throw error;
  }
};

// Maps para mantener relaciones entre IDs
const userIdMap = new Map();
const sectorIdMap = new Map();

// Funci√≥n para migrar usuarios
const migrateUsers = async () => {
  console.log('üë• Migrando usuarios...');
  
  const mongoUsers = await UserMongo.find();
  console.log(`Encontrados ${mongoUsers.length} usuarios en MongoDB`);
  
  for (const mongoUser of mongoUsers) {
    try {
      // Generar nuevo UUID para PostgreSQL
      const newUserId = uuidv4();
      userIdMap.set(mongoUser._id.toString(), newUserId);
      
      // Verificar si el usuario ya existe en PostgreSQL
      const existingUser = await User.findOne({ 
        where: { email: mongoUser.email } 
      });
      
      if (existingUser) {
        console.log(`‚ö†Ô∏è  Usuario ${mongoUser.email} ya existe, omitiendo...`);
        userIdMap.set(mongoUser._id.toString(), existingUser.id);
        continue;
      }
      
      // Migrar usuario con password seguro
      const userData = {
        id: newUserId,
        username: mongoUser.username || mongoUser.email.split('@')[0],
        email: mongoUser.email,
        password: mongoUser.password || '$2a$10$defaultHashForMigration123456789', // Password temporal si no existe
        fullName: mongoUser.fullName || '',
        role: mongoUser.role || 'viewer',
        isActive: mongoUser.isActive !== false,
        lastLogin: mongoUser.lastLogin,
        profileImage: mongoUser.profileImage || '',
        department: mongoUser.department || '',
        position: mongoUser.position || '',
        phone: mongoUser.phone || '',
        emailNotifications: mongoUser.emailNotifications !== false,
        invitedBy: null, // Se manejar√° despu√©s si hay referencias
        invitationAcceptedAt: mongoUser.invitationAcceptedAt,
        createdAt: mongoUser.createdAt || new Date(),
        updatedAt: mongoUser.updatedAt || new Date()
      };
      
      // Crear usuario sin triggear el hash (ya est√° hasheado)
      await User.create(userData, { 
        hooks: false // No ejecutar hooks para mantener password ya hasheado
      });
      
      console.log(`‚úÖ Usuario migrado: ${mongoUser.email} (${newUserId})`);
    } catch (error) {
      console.error(`‚ùå Error migrando usuario ${mongoUser.email}:`, error.message);
    }
  }
};

// Funci√≥n para migrar sectores
const migrateSectors = async () => {
  console.log('üìÅ Migrando sectores...');
  
  const mongoSectors = await SectorMongo.find();
  console.log(`Encontrados ${mongoSectors.length} sectores/subsectores en MongoDB`);
  
  // Primero migrar sectores padre (sin parentId)
  const sectoresPadre = mongoSectors.filter(s => !s.parentId);
  const subsectores = mongoSectors.filter(s => s.parentId);
  
  // Migrar sectores padre primero
  for (const mongoSector of sectoresPadre) {
    try {
      const newSectorId = uuidv4();
      sectorIdMap.set(mongoSector._id.toString(), newSectorId);
      
      // Obtener el ID del usuario propietario
      const ownerId = userIdMap.get(mongoSector.ownerId.toString());
      if (!ownerId) {
        console.log(`‚ö†Ô∏è  No se encontr√≥ el propietario para el sector ${mongoSector.nombre}, omitiendo...`);
        continue;
      }
      
      // Manejar ubicaci√≥n - si es array, convertir a string
      let ubicacion = mongoSector.ubicacion || '';
      if (Array.isArray(ubicacion)) {
        ubicacion = ubicacion.join(', ');
      } else if (typeof ubicacion === 'object') {
        ubicacion = JSON.stringify(ubicacion);
      }
      
      const sectorData = {
        id: newSectorId,
        nombre: mongoSector.nombre,
        descripcion: mongoSector.descripcion || '',
        codigo: mongoSector.codigo || null,
        ubicacion: ubicacion,
        telefono: mongoSector.telefono || '',
        email: mongoSector.email || null,
        jefeNombre: mongoSector.jefe?.nombre || null,
        jefeCargo: mongoSector.jefe?.cargo || null,
        jefeContacto: mongoSector.jefe?.contacto || null,
        configuracion: mongoSector.configuracion || {},
        ownerId: ownerId,
        type: mongoSector.type || 'sector',
        parentId: null, // Es un sector padre
        activo: mongoSector.activo !== false,
        orden: mongoSector.orden || 0,
        createdAt: mongoSector.createdAt || new Date(),
        updatedAt: mongoSector.updatedAt || new Date()
      };
      
      await Sector.create(sectorData);
      console.log(`‚úÖ Sector migrado: ${mongoSector.nombre} (${newSectorId})`);
    } catch (error) {
      console.error(`‚ùå Error migrando sector ${mongoSector.nombre}:`, error.message);
    }
  }
  
  // Luego migrar subsectores
  for (const mongoSector of subsectores) {
    try {
      const newSectorId = uuidv4();
      sectorIdMap.set(mongoSector._id.toString(), newSectorId);
      
      // Obtener el ID del usuario propietario
      const ownerId = userIdMap.get(mongoSector.ownerId.toString());
      if (!ownerId) {
        console.log(`‚ö†Ô∏è  No se encontr√≥ el propietario para el subsector ${mongoSector.nombre}, omitiendo...`);
        continue;
      }
      
      // Obtener el ID del sector padre
      const parentId = sectorIdMap.get(mongoSector.parentId.toString());
      if (!parentId) {
        console.log(`‚ö†Ô∏è  No se encontr√≥ el sector padre para el subsector ${mongoSector.nombre}, omitiendo...`);
        continue;
      }
      
      // Manejar ubicaci√≥n - si es array, convertir a string
      let ubicacion = mongoSector.ubicacion || '';
      if (Array.isArray(ubicacion)) {
        ubicacion = ubicacion.join(', ');
      } else if (typeof ubicacion === 'object') {
        ubicacion = JSON.stringify(ubicacion);
      }
      
      const sectorData = {
        id: newSectorId,
        nombre: mongoSector.nombre,
        descripcion: mongoSector.descripcion || '',
        codigo: mongoSector.codigo || null,
        ubicacion: ubicacion,
        telefono: mongoSector.telefono || '',
        email: mongoSector.email || null,
        jefeNombre: mongoSector.jefe?.nombre || null,
        jefeCargo: mongoSector.jefe?.cargo || null,
        jefeContacto: mongoSector.jefe?.contacto || null,
        configuracion: mongoSector.configuracion || {},
        ownerId: ownerId,
        type: mongoSector.type || 'subsector',
        parentId: parentId,
        activo: mongoSector.activo !== false,
        orden: mongoSector.orden || 0,
        createdAt: mongoSector.createdAt || new Date(),
        updatedAt: mongoSector.updatedAt || new Date()
      };
      
      await Sector.create(sectorData);
      console.log(`‚úÖ Subsector migrado: ${mongoSector.nombre} (${newSectorId})`);
    } catch (error) {
      console.error(`‚ùå Error migrando subsector ${mongoSector.nombre}:`, error.message);
    }
  }
};

// Funci√≥n para migrar veh√≠culos
const migrateVehiculos = async () => {
  console.log('üöó Migrando veh√≠culos...');
  
  const mongoVehiculos = await VehiculoMongo.find();
  console.log(`Encontrados ${mongoVehiculos.length} veh√≠culos en MongoDB`);
  
  for (const mongoVehiculo of mongoVehiculos) {
    try {
      const newVehiculoId = uuidv4();
      
      // Obtener IDs de usuario y subsector
      const ownerId = userIdMap.get(mongoVehiculo.ownerId.toString());
      const subsectorId = sectorIdMap.get(mongoVehiculo.subsectorId.toString());
      
      if (!ownerId) {
        console.log(`‚ö†Ô∏è  No se encontr√≥ el propietario para el veh√≠culo ${mongoVehiculo.placa}, omitiendo...`);
        continue;
      }
      
      if (!subsectorId) {
        console.log(`‚ö†Ô∏è  No se encontr√≥ el subsector para el veh√≠culo ${mongoVehiculo.placa}, omitiendo...`);
        continue;
      }
      
      const vehiculoData = {
        id: newVehiculoId,
        sectorQueOpera: mongoVehiculo.sectorQueOpera || '',
        tipoVehiculo: mongoVehiculo.tipoVehiculo || 'Otro',
        marca: mongoVehiculo.marca || '',
        linea: mongoVehiculo.linea || '',
        modelo: mongoVehiculo.modelo || '',
        placa: mongoVehiculo.placa || '',
        numeroChasis: mongoVehiculo.numeroChasis || '',
        numeroMotor: mongoVehiculo.numeroMotor || '',
        color: mongoVehiculo.color || '',
        cilindraje: mongoVehiculo.cilindraje || '',
        combustible: mongoVehiculo.combustible || null,
        propietario: mongoVehiculo.propietario || {
          nombre: '',
          documento: { tipo: '', numero: '' },
          telefono: '',
          direccion: ''
        },
        soat: mongoVehiculo.soat || {
          numeroPoliza: '',
          vigencia: null,
          aseguradora: ''
        },
        tecnomecanica: mongoVehiculo.tecnomecanica || {
          numero: '',
          vigencia: null,
          cda: ''
        },
        estado: mongoVehiculo.estado || 'Activo',
        fechaIncidente: mongoVehiculo.fechaIncidente || null,
        lugarIncidente: mongoVehiculo.lugarIncidente || '',
        tipoIncidente: mongoVehiculo.tipoIncidente || '',
        observaciones: mongoVehiculo.observaciones || '',
        caracteristicasParticulares: mongoVehiculo.caracteristicasParticulares || '',
        fotos: mongoVehiculo.fotos || [],
        documentosRelacionados: mongoVehiculo.documentosRelacionados || [],
        googleEarthUrl: mongoVehiculo.googleEarthUrl || '',
        ownerId: ownerId,
        subsectorId: subsectorId,
        activo: mongoVehiculo.activo !== false,
        createdAt: mongoVehiculo.createdAt || new Date(),
        updatedAt: mongoVehiculo.updatedAt || new Date()
      };
      
      await Vehiculo.create(vehiculoData);
      console.log(`‚úÖ Veh√≠culo migrado: ${mongoVehiculo.placa || 'Sin placa'} - ${mongoVehiculo.marca} ${mongoVehiculo.linea} (${newVehiculoId})`);
    } catch (error) {
      console.error(`‚ùå Error migrando veh√≠culo ${mongoVehiculo.placa}:`, error.message);
    }
  }
};

// Funci√≥n para migrar indiciados
const migrateIndiciados = async () => {
  console.log('üë§ Migrando indiciados...');
  
  const mongoIndiciados = await IndiciadoMongo.find();
  console.log(`Encontrados ${mongoIndiciados.length} indiciados en MongoDB`);
  
  for (const mongoIndiciado of mongoIndiciados) {
    try {
      const newIndiciadoId = uuidv4();
      
      // Obtener IDs de usuario y subsector
      const ownerId = userIdMap.get(mongoIndiciado.ownerId.toString());
      const subsectorId = sectorIdMap.get(mongoIndiciado.subsectorId.toString());
      
      if (!ownerId) {
        console.log(`‚ö†Ô∏è  No se encontr√≥ el propietario para el indiciado ${mongoIndiciado.nombre}, omitiendo...`);
        continue;
      }
      
      if (!subsectorId) {
        console.log(`‚ö†Ô∏è  No se encontr√≥ el subsector para el indiciado ${mongoIndiciado.nombre}, omitiendo...`);
        continue;
      }
      
      // Validar email - si no es v√°lido, usar string vac√≠o
      let email = mongoIndiciado.email || '';
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (email && !emailRegex.test(email)) {
        console.log(`‚ö†Ô∏è  Email inv√°lido para ${mongoIndiciado.nombre}: ${email}, usando email vac√≠o`);
        email = '';
      }
      
      const indiciadoData = {
        id: newIndiciadoId,
        sectorQueOpera: mongoIndiciado.sectorQueOpera || '',
        nombre: mongoIndiciado.nombre,
        apellidos: mongoIndiciado.apellidos,
        alias: mongoIndiciado.alias || '',
        documentoIdentidad: mongoIndiciado.documentoIdentidad || {
          tipo: '',
          numero: '',
          expedidoEn: ''
        },
        fechaNacimiento: mongoIndiciado.fechaNacimiento || {
          fecha: null,
          lugar: ''
        },
        edad: mongoIndiciado.edad,
        hijoDe: mongoIndiciado.hijoDe || '',
        genero: mongoIndiciado.genero || null,
        estadoCivil: mongoIndiciado.estadoCivil || null,
        nacionalidad: mongoIndiciado.nacionalidad || '',
        residencia: mongoIndiciado.residencia || '',
        direccion: mongoIndiciado.direccion || '',
        telefono: mongoIndiciado.telefono || '',
        email: email,
        estudiosRealizados: mongoIndiciado.estudiosRealizados || '',
        profesion: mongoIndiciado.profesion || '',
        oficio: mongoIndiciado.oficio || '',
        senalesFisicas: mongoIndiciado.senalesFisicas || {
          estatura: '',
          peso: '',
          contexturaFisica: '',
          colorPiel: '',
          colorOjos: '',
          colorCabello: '',
          marcasEspeciales: '',
          tatuajes: '',
          cicatrices: '',
          piercing: '',
          deformidades: '',
          otras: ''
        },
        informacionMedica: mongoIndiciado.informacionMedica || {
          enfermedades: '',
          medicamentos: '',
          alergias: '',
          discapacidades: '',
          adicciones: '',
          tratamientos: ''
        },
        informacionDelito: mongoIndiciado.informacionDelito || {
          fechaDelito: null,
          lugarDelito: '',
          tipoDelito: '',
          modalidad: '',
          descripcionHechos: '',
          victimas: [],
          testigos: [],
          coautores: []
        },
        informacionJudicial: mongoIndiciado.informacionJudicial || {
          numeroRadicado: '',
          fiscalAsignado: '',
          juzgado: '',
          estadoProceso: '',
          fechaCaptura: null,
          lugarCaptura: '',
          ordenesPendientes: [],
          antecedentes: []
        },
        informacionPolicial: mongoIndiciado.informacionPolicial || {
          unidadCaptura: '',
          investigadorAsignado: '',
          numeroInvestigacion: '',
          clasificacionRiesgo: '',
          observacionesEspeciales: ''
        },
        estado: mongoIndiciado.estado || 'Activo',
        foto: mongoIndiciado.foto || {
          filename: '',
          originalName: '',
          mimeType: '',
          size: 0,
          path: '',
          fechaSubida: null
        },
        fotosAdicionales: mongoIndiciado.fotosAdicionales || [],
        documentosRelacionados: mongoIndiciado.documentosRelacionados || [],
        googleEarthUrl: mongoIndiciado.googleEarthUrl || '',
        observaciones: mongoIndiciado.observaciones || '',
        ownerId: ownerId,
        subsectorId: subsectorId,
        activo: mongoIndiciado.activo !== false,
        createdAt: mongoIndiciado.createdAt || new Date(),
        updatedAt: mongoIndiciado.updatedAt || new Date()
      };
      
      await Indiciado.create(indiciadoData);
      console.log(`‚úÖ Indiciado migrado: ${mongoIndiciado.nombre} ${mongoIndiciado.apellidos} (${newIndiciadoId})`);
    } catch (error) {
      console.error(`‚ùå Error migrando indiciado ${mongoIndiciado.nombre}:`, error.message);
    }
  }
};

// Funci√≥n principal de migraci√≥n
const runMigration = async () => {
  try {
    console.log('üöÄ Iniciando migraci√≥n de MongoDB a PostgreSQL...\\n');
    
    // Conectar a ambas bases de datos
    await connectMongoDB();
    
    // Verificar conexi√≥n a PostgreSQL
    const pgConnected = await require('./config/database').testConnection();
    if (!pgConnected) {
      throw new Error('No se pudo conectar a PostgreSQL');
    }
    
    // Sincronizar modelos de PostgreSQL (crear tablas)
    console.log('üìã Creando estructura de tablas en PostgreSQL...');
    await syncDatabase(true); // true para forzar recreaci√≥n (cuidado con datos existentes)
    
    // Migrar datos en orden de dependencias
    await migrateUsers();
    console.log('');
    
    await migrateSectors();
    console.log('');
    
    await migrateVehiculos();
    console.log('');
    
    await migrateIndiciados();
    console.log('');
    
    console.log('üéâ ¬°Migraci√≥n completada exitosamente!');
    console.log('');
    console.log('üìä Resumen de la migraci√≥n:');
    
    // Mostrar estad√≠sticas
    const statsUsers = await User.count();
    const statsSectors = await Sector.count();
    const statsVehiculos = await Vehiculo.count();
    const statsIndiciados = await Indiciado.count();
    
    console.log(`   üë• Usuarios: ${statsUsers}`);
    console.log(`   üìÅ Sectores/Subsectores: ${statsSectors}`);
    console.log(`   üöó Veh√≠culos: ${statsVehiculos}`);
    console.log(`   üë§ Indiciados: ${statsIndiciados}`);
    console.log('');
    console.log('‚ú® Para usar PostgreSQL, ejecuta: npm run start:postgres');
    
  } catch (error) {
    console.error('üí• Error durante la migraci√≥n:', error);
    throw error;
  } finally {
    // Cerrar conexiones
    await mongoose.connection.close();
    await sequelize.close();
  }
};

// Ejecutar migraci√≥n si se llama directamente
if (require.main === module) {
  runMigration()
    .then(() => {
      console.log('üèÅ Migraci√≥n finalizada');
      process.exit(0);
    })
    .catch((error) => {
      console.error('üí• Fall√≥ la migraci√≥n:', error);
      process.exit(1);
    });
}

module.exports = { runMigration };
